#!/bin/bash

# Check if we have at least a directory and one file
if [ $# -lt 2 ]; then
  echo "Usage: $0 /path/to/directory file1.mcap [file2.mcap ...]"
  exit 1
fi

# Use the first argument as the directory path
DIRECTORY="$1"
shift  # Remove directory from arguments, leaving only filenames

# Check if the directory exists
if [ ! -d "$DIRECTORY" ]; then
  echo "Error: Directory $DIRECTORY does not exist."
  exit 1
fi

echo "Starting recovery process in directory: $DIRECTORY"
echo "Processing selected files: $@"

# Process each selected file
for filename in "$@"; do
  file="$DIRECTORY/$filename"
  if [ -f "$file" ]; then
    # Extract the file name without the extension and append -rec
    base_name="${file%.mcap}-rec.mcap"
    
    echo "Processing file: $file -> $base_name"

    # Run mcap recover command
    if mcap recover "$file" -o "$base_name"; then
      echo "Successfully recovered: $base_name"
    else
      echo "Failed to recover: $file"
      exit 1
    fi
  else
    echo "Error: File $file does not exist."
    exit 1
  fi
done

echo "Recovery process completed successfully"
